<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NabulAir Pro - IoT Device Manager</title>
    
    <!-- CDN Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.3.0/chart.umd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --nabulair-blue: #2980b9;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--nabulair-blue) 100%);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--nabulair-blue) !important;
        }
        
        .device-card {
            border-left: 4px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .device-card:hover {
            background-color: #f8f9fa;
        }
        
        .device-online {
            border-left-color: var(--success-color);
        }
        
        .device-offline {
            border-left-color: var(--danger-color);
        }
        
        .device-maintenance {
            border-left-color: var(--warning-color);
        }
        
        .device-alert {
            border-left-color: var(--warning-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--nabulair-blue);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .telemetry-chart {
            background: white;
            border-radius: 10px;
            padding: 15px;
            height: 300px;
        }
        
        .system-badge {
            font-size: 0.7rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        .context-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .context-card:hover {
            transform: scale(1.05);
        }
        
        .telemetry-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--nabulair-blue);
        }
        
        .auth-tabs .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        
        .auth-tabs .nav-link.active {
            color: var(--nabulair-blue);
            border-bottom: 3px solid var(--nabulair-blue);
        }
        
        .welcome-screen {
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .guide-steps {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .step-card {
            border-left: 4px solid var(--nabulair-blue);
            margin-bottom: 1rem;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .context-badge {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- Auth Section (Login/Register) -->
    <section id="authSection" class="login-container d-flex align-items-center justify-content-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="text-center mb-4">
                                <i class="fas fa-wind fa-3x text-primary mb-3"></i>
                                <h2 class="card-title">NabulAir Pro</h2>
                                <p class="text-muted">Sistema di Gestione Dispositivi IoT</p>
                            </div>
                            
                            <!-- Auth Tabs -->
                            <ul class="nav nav-pills nav-fill auth-tabs mb-4" id="authTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="login-tab" data-bs-toggle="tab" 
                                            data-bs-target="#login" type="button" role="tab">
                                        <i class="fas fa-sign-in-alt me-2"></i>Accedi
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="register-tab" data-bs-toggle="tab" 
                                            data-bs-target="#register" type="button" role="tab">
                                        <i class="fas fa-user-plus me-2"></i>Registrati
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="authTabsContent">
                                <!-- Login Tab -->
                                <div class="tab-pane fade show active" id="login" role="tabpanel">
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="password" required>
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-sign-in-alt me-2"></i>Accedi
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="mt-4 p-3 bg-light rounded">
                                        <h6 class="text-center">Credenziali Demo:</h6>
                                        <small class="text-muted d-block">Admin: admin / admin123</small>
                                        <small class="text-muted d-block">Rivenditore: rivenditore1 / rivenditore123</small>
                                        <small class="text-muted">Cliente: cliente1 / cliente123</small>
                                    </div>
                                    
                                    <div id="loginError" class="alert alert-danger mt-3 hidden" role="alert">
                                        Errore durante il login. Controlla le credenziali.
                                    </div>
                                </div>
                                
                                <!-- Register Tab -->
                                <div class="tab-pane fade" id="register" role="tabpanel">
                                    <form id="registerForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="regUsername" class="form-label">Username *</label>
                                                <input type="text" class="form-control" id="regUsername" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="regCompany" class="form-label">Azienda *</label>
                                                <input type="text" class="form-control" id="regCompany" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="regEmail" class="form-label">Email *</label>
                                                <input type="email" class="form-control" id="regEmail" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="regRole" class="form-label">Tipo Account *</label>
                                                <select class="form-select" id="regRole" required>
                                                    <option value="">Seleziona tipo...</option>
                                                    <option value="reseller">Rivenditore</option>
                                                    <option value="customer">Cliente</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3 hidden" id="resellerCodeGroup">
                                            <div class="col-12">
                                                <label for="regResellerCode" class="form-label">Codice Rivenditore *</label>
                                                <input type="text" class="form-control" id="regResellerCode">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3 hidden" id="resellerSelectGroup">
                                            <div class="col-12">
                                                <label for="regResellerSelect" class="form-label">Seleziona Rivenditore *</label>
                                                <select class="form-select" id="regResellerSelect">
                                                    <option value="">Caricamento rivenditori...</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="regPassword" class="form-label">Password *</label>
                                                <input type="password" class="form-control" id="regPassword" required minlength="6">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="regConfirmPassword" class="form-label">Conferma Password *</label>
                                                <input type="password" class="form-control" id="regConfirmPassword" required>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success btn-lg">
                                                <i class="fas fa-user-plus me-2"></i>Crea Account
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div id="registerError" class="alert alert-danger mt-3 hidden" role="alert"></div>
                                    <div id="registerSuccess" class="alert alert-success mt-3 hidden" role="alert"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Context Selection Section -->
    <section id="contextSection" class="hidden">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-10 text-center">
                    <h2 class="mb-3">Benvenuto in NabulAir Pro</h2>
                    <p class="text-muted mb-4">Scegli come vuoi accedere alla piattaforma</p>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-5 mb-4">
                            <div class="card h-100 context-card" data-context="dashboard">
                                <div class="card-body p-4">
                                    <i class="fas fa-tachometer-alt fa-3x text-primary mb-3"></i>
                                    <h4>Dashboard Principale</h4>
                                    <p class="text-muted">Monitora tutti i dispositivi e le statistiche</p>
                                    <span class="badge bg-primary context-badge">Visualizzazione Dati</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 mb-4">
                            <div class="card h-100 context-card" data-context="device-management">
                                <div class="card-body p-4">
                                    <i class="fas fa-microchip fa-3x text-warning mb-3"></i>
                                    <h4>Gestione Dispositivi</h4>
                                    <p class="text-muted">Aggiungi e gestisci i dispositivi</p>
                                    <span class="badge bg-warning context-badge">Configurazione</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-secondary" id="logoutFromContextBtn">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main App Section -->
    <section id="appSection" class="hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-wind me-2"></i>NabulAir Pro
                    <span class="badge bg-light text-dark ms-2" id="contextBadge">Dashboard</span>
                </a>
                
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName">Utente</span>
                            <span class="badge bg-light text-dark ms-1" id="userRoleBadge">Role</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="switchContextBtn"><i class="fas fa-random me-2"></i>Cambia Contesto</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Welcome Screen (shown when no devices) -->
            <div class="row mb-4 hidden" id="welcomeScreen">
                <div class="col-12">
                    <div class="card welcome-screen">
                        <div class="card-body text-center">
                            <i class="fas fa-microchip fa-4x text-muted mb-4"></i>
                            <h3 class="mb-3">Benvenuto in NabulAir Pro</h3>
                            <p class="text-muted mb-4">Non hai ancora dispositivi registrati. Inizia ora per monitorare i tuoi sistemi NabulAir.</p>
                            
                            <div class="guide-steps">
                                <div class="card step-card mb-3">
                                    <div class="card-body">
                                        <h5><i class="fas fa-plus-circle text-primary me-2"></i>Passo 1: Registra il tuo primo dispositivo</h5>
                                        <p class="mb-0">Vai nella sezione "Gestione Dispositivi" per aggiungere un nuovo dispositivo NabulAir.</p>
                                    </div>
                                </div>
                                
                                <div class="card step-card mb-3">
                                    <div class="card-body">
                                        <h5><i class="fas fa-plug text-success me-2"></i>Passo 2: Connetti il dispositivo</h5>
                                        <p class="mb-0">Assicurati che il dispositivo sia alimentato e connesso alla rete.</p>
                                    </div>
                                </div>
                                
                                <div class="card step-card">
                                    <div class="card-body">
                                        <h5><i class="fas fa-chart-line text-info me-2"></i>Passo 3: Monitora le prestazioni</h5>
                                        <p class="mb-0">Torna nella Dashboard per visualizzare i dati in tempo reale.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-primary btn-lg" id="goToDeviceManagement">
                                    <i class="fas fa-rocket me-2"></i>Inizia Ora
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Context -->
            <div id="dashboardContext">
                <!-- Dashboard Stats -->
                <div class="row mb-4" id="dashboardStats">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <i class="fas fa-microchip fa-2x text-primary mb-2"></i>
                            <div class="stat-value" id="totalDevices">0</div>
                            <div class="text-muted">Dispositivi Totali</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <div class="stat-value" id="onlineDevices">0</div>
                            <div class="text-muted">Dispositivi Online</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                            <div class="stat-value" id="alertDevices">0</div>
                            <div class="text-muted">Allerte Attive</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <div class="stat-value" id="dataPoints">0</div>
                            <div class="text-muted">Dati Oggi</div>
                        </div>
                    </div>
                </div>

                <!-- Devices List and Telemetry -->
                <div class="row">
                    <!-- Devices List -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Dispositivi NabulAir</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" id="refreshDevicesBtn">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="devicesList">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Caricamento dispositivi...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Caricamento dispositivi...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Telemetry and Controls -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span id="selectedDeviceName">Telemetria</span>
                                </h5>
                                <span class="badge bg-success hidden" id="onlineStatusBadge">Online</span>
                            </div>
                            <div class="card-body">
                                <!-- Current Telemetry -->
                                <div class="row mb-4" id="currentTelemetry">
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Stato Sistema</small>
                                        <div class="telemetry-value" id="telemetryStatus">--</div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Ciclo Attivo</small>
                                        <div class="telemetry-value" id="telemetryCiclo">--</div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Secondi Rimanenti</small>
                                        <div class="telemetry-value" id="telemetrySecondi">--</div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <small class="text-muted">Volume Acqua (L)</small>
                                        <div class="telemetry-value" id="telemetryVolume">--</div>
                                    </div>
                                </div>

                                <!-- Telemetry Chart -->
                                <div class="telemetry-chart mb-4">
                                    <canvas id="telemetryChart"></canvas>
                                </div>
                                
                                <!-- Device Controls -->
                                <div class="mt-4" id="deviceControls">
                                    <h6>Controlli Dispositivo</h6>
                                    <div class="d-grid gap-2 d-md-flex">
                                        <button class="btn btn-outline-primary" id="startCycleBtn" disabled>
                                            <i class="fas fa-play me-1"></i>Avvia Ciclo
                                        </button>
                                        <button class="btn btn-outline-warning" id="stopCycleBtn" disabled>
                                            <i class="fas fa-stop me-1"></i>Ferma Ciclo
                                        </button>
                                        <button class="btn btn-outline-danger" id="rebootDeviceBtn" disabled>
                                            <i class="fas fa-power-off me-1"></i>Riavvia
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div class="row hidden" id="alertsSection">
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Allerte Attive</h5>
                                <button class="btn btn-sm btn-outline-dark" id="refreshAlertsBtn">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="alertsList">
                                    <!-- Alerts will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Management Context -->
            <div id="deviceManagementContext" class="hidden">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Gestione Dispositivi</h5>
                            </div>
                            <div class="card-body">
                                <!-- Device Management Form -->
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Registra Nuovo Dispositivo NabulAir</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="addDeviceForm">
                                            <!-- Admin Flow: Rivenditore → Cliente -->
                                            <div class="row mb-3" id="adminFlow">
                                                <div class="col-md-6">
                                                    <label for="resellerSelect" class="form-label">Seleziona Rivenditore</label>
                                                    <select class="form-select" id="resellerSelect" required>
                                                        <option value="">Caricamento rivenditori...</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="customerSelect" class="form-label">Seleziona Cliente</label>
                                                    <select class="form-select" id="customerSelect" required disabled>
                                                        <option value="">Seleziona prima un rivenditore</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Reseller Flow: Solo clienti -->
                                            <div class="row mb-3 hidden" id="resellerFlow">
                                                <div class="col-12">
                                                    <label for="resellerCustomerSelect" class="form-label">Seleziona Cliente</label>
                                                    <select class="form-select" id="resellerCustomerSelect" required>
                                                        <option value="">Caricamento clienti...</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Device Information -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="deviceId" class="form-label">ID Dispositivo *</label>
                                                    <input type="text" class="form-control" id="deviceId" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="deviceName" class="form-label">Nome Dispositivo *</label>
                                                    <input type="text" class="form-control" id="deviceName" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="systemType" class="form-label">Sistema NabulAir *</label>
                                                    <select class="form-select" id="systemType" required>
                                                        <option value="">Seleziona sistema...</option>
                                                        <option value="pro">NabulAir Pro</option>
                                                        <option value="pro_duo">NabulAir Pro Duo</option>
                                                        <option value="pro_duo_plus">NabulAir Pro Duo Plus</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="ownerEmail" class="form-label">Email Cliente</label>
                                                    <input type="email" class="form-control" id="ownerEmail">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <label for="location" class="form-label">Indirizzo Installazione</label>
                                                    <input type="text" class="form-control" id="location">
                                                </div>
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fas fa-save me-2"></i>Registra Dispositivo
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Existing Devices -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Dispositivi Registrati</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="managementDevicesList">
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Caricamento dispositivi...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Caricamento dispositivi...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // App State
        const appState = {
            user: null,
            token: null,
            devices: [],
            selectedDevice: null,
            telemetryData: {},
            socket: null,
            currentContext: 'dashboard',
            chart: null,
            hasDevices: false
        };

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const contextSection = document.getElementById('contextSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const registerSuccess = document.getElementById('registerSuccess');
        const userName = document.getElementById('userName');
        const userRoleBadge = document.getElementById('userRoleBadge');
        const contextBadge = document.getElementById('contextBadge');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutFromContextBtn = document.getElementById('logoutFromContextBtn');
        const switchContextBtn = document.getElementById('switchContextBtn');
        
        // Context Elements
        const dashboardContext = document.getElementById('dashboardContext');
        const deviceManagementContext = document.getElementById('deviceManagementContext');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const goToDeviceManagement = document.getElementById('goToDeviceManagement');
        
        // Dashboard Elements
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const devicesList = document.getElementById('devicesList');
        const alertsSection = document.getElementById('alertsSection');
        const alertsList = document.getElementById('alertsList');
        const refreshAlertsBtn = document.getElementById('refreshAlertsBtn');

        // Device Management Elements
        const addDeviceForm = document.getElementById('addDeviceForm');
        const adminFlow = document.getElementById('adminFlow');
        const resellerFlow = document.getElementById('resellerFlow');
        const managementDevicesList = document.getElementById('managementDevicesList');

        // Registration Form Elements
        const regRole = document.getElementById('regRole');
        const resellerCodeGroup = document.getElementById('resellerCodeGroup');
        const resellerSelectGroup = document.getElementById('resellerSelectGroup');
        const regResellerCode = document.getElementById('regResellerCode');
        const regResellerSelect = document.getElementById('regResellerSelect');

        // Telemetry Elements
        const selectedDeviceName = document.getElementById('selectedDeviceName');
        const onlineStatusBadge = document.getElementById('onlineStatusBadge');
        const telemetryStatus = document.getElementById('telemetryStatus');
        const telemetryCiclo = document.getElementById('telemetryCiclo');
        const telemetrySecondi = document.getElementById('telemetrySecondi');
        const telemetryVolume = document.getElementById('telemetryVolume');

        // Control Buttons
        const startCycleBtn = document.getElementById('startCycleBtn');
        const stopCycleBtn = document.getElementById('stopCycleBtn');
        const rebootDeviceBtn = document.getElementById('rebootDeviceBtn');

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingAuth();
            setupEventListeners();
            loadAvailableResellers();
        });

        function checkExistingAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                appState.token = token;
                appState.user = JSON.parse(user);
                showContextSelection();
            }
        }

        function setupEventListeners() {
            // Auth Tabs
            document.getElementById('authTabs').addEventListener('shown.bs.tab', function(e) {
                if (e.target.id === 'login-tab') {
                    registerError.classList.add('hidden');
                    registerSuccess.classList.add('hidden');
                } else {
                    loginError.classList.add('hidden');
                }
            });

            // Login
            loginForm.addEventListener('submit', handleLogin);
            
            // Registration
            registerForm.addEventListener('submit', handleRegister);
            regRole.addEventListener('change', handleRoleChange);
            
            // Context Selection
            document.querySelectorAll('.context-card').forEach(card => {
                card.addEventListener('click', function() {
                    const context = this.getAttribute('data-context');
                    enterApp(context);
                });
            });
            
            // Navigation
            logoutBtn.addEventListener('click', handleLogout);
            logoutFromContextBtn.addEventListener('click', handleLogout);
            switchContextBtn.addEventListener('click', showContextSelection);
            goToDeviceManagement.addEventListener('click', () => enterApp('device-management'));
            
            // Dashboard
            refreshDevicesBtn.addEventListener('click', loadDevices);
            
            // Device Management
            addDeviceForm.addEventListener('submit', handleAddDevice);
            
            // Role-based form flow
            const resellerSelect = document.getElementById('resellerSelect');
            if (resellerSelect) {
                resellerSelect.addEventListener('change', function() {
                    loadResellerCustomers(this.value);
                });
            }
            
            // Device Controls
            startCycleBtn.addEventListener('click', () => sendCommand('start_cycle'));
            stopCycleBtn.addEventListener('click', () => sendCommand('stop_cycle'));
            rebootDeviceBtn.addEventListener('click', () => sendCommand('reboot'));
            
            // Alerts
            refreshAlertsBtn.addEventListener('click', loadAlerts);
        }

        // Registration Functions
        function handleRoleChange() {
            const role = regRole.value;
            
            resellerCodeGroup.classList.add('hidden');
            resellerSelectGroup.classList.add('hidden');
            regResellerCode.required = false;
            regResellerSelect.required = false;
            
            if (role === 'reseller') {
                resellerCodeGroup.classList.remove('hidden');
                regResellerCode.required = true;
            } else if (role === 'customer') {
                resellerSelectGroup.classList.remove('hidden');
                regResellerSelect.required = true;
            }
        }

        async function loadAvailableResellers() {
            try {
                // In a real app, this would be a public API endpoint
                const select = document.getElementById('regResellerSelect');
                select.innerHTML = `
                    <option value="">Seleziona rivenditore...</option>
                    <option value="RES_NORD">Rivenditore Nord Italia (RES_NORD)</option>
                    <option value="RES_CENTRO">Rivenditore Centro Italia (RES_CENTRO)</option>
                    <option value="RES_SUD">Rivenditore Sud Italia (RES_SUD)</option>
                `;
            } catch (error) {
                console.error('Error loading resellers for registration:', error);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPassword').value,
                company: document.getElementById('regCompany').value,
                email: document.getElementById('regEmail').value,
                role: document.getElementById('regRole').value
            };
            
            if (formData.role === 'reseller') {
                formData.resellerCode = document.getElementById('regResellerCode').value;
            } else if (formData.role === 'customer') {
                formData.resellerCode = document.getElementById('regResellerSelect').value;
            }
            
            if (formData.password !== document.getElementById('regConfirmPassword').value) {
                showRegisterError('Le password non coincidono');
                return;
            }
            
            try {
                // Simulate registration - in a real app this would be an API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // For demo purposes, we'll simulate successful registration
                showRegisterSuccess('Account creato con successo! Ora puoi effettuare il login.');
                registerForm.reset();
                setTimeout(() => {
                    document.getElementById('login-tab').click();
                }, 2000);
            } catch (error) {
                console.error('Registration error:', error);
                showRegisterError('Errore durante la registrazione. Riprova più tardi.');
            }
        }

        function showRegisterError(message) {
            registerError.textContent = message;
            registerError.classList.remove('hidden');
            registerSuccess.classList.add('hidden');
        }

        function showRegisterSuccess(message) {
            registerSuccess.textContent = message;
            registerSuccess.classList.remove('hidden');
            registerError.classList.add('hidden');
        }

        // === AUTHENTICATION AND NAVIGATION ===

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                // Simulate API call - in a real app this would be a real endpoint
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Demo authentication - in production this would be validated server-side
                let userData;
                
                if (username === 'admin' && password === 'admin123') {
                    userData = {
                        username: 'admin',
                        role: 'admin',
                        company: 'NabulAir S.p.A.'
                    };
                } else if (username === 'rivenditore1' && password === 'rivenditore123') {
                    userData = {
                        username: 'rivenditore1',
                        role: 'reseller',
                        company: 'Rivenditore Nord Italia',
                        resellerCode: 'RES_NORD'
                    };
                } else if (username === 'cliente1' && password === 'cliente123') {
                    userData = {
                        username: 'cliente1',
                        role: 'customer',
                        company: 'Azienda Cliente Demo',
                        resellerCode: 'RES_NORD'
                    };
                } else {
                    throw new Error('Credenziali non valide');
                }
                
                // Simulate token generation
                const token = 'demo_token_' + Math.random().toString(36).substr(2);
                
                appState.token = token;
                appState.user = userData;
                
                localStorage.setItem('authToken', appState.token);
                localStorage.setItem('user', JSON.stringify(appState.user));
                
                loginError.classList.add('hidden');
                showContextSelection();
            } catch (error) {
                console.error('Login error:', error);
                loginError.classList.remove('hidden');
            }
        }

        function showContextSelection() {
            authSection.classList.add('hidden');
            appSection.classList.add('hidden');
            contextSection.classList.remove('hidden');
        }

        function enterApp(context) {
            appState.currentContext = context;
            contextSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            
            userName.textContent = appState.user.username;
            userRoleBadge.textContent = getRoleLabel(appState.user.role);
            contextBadge.textContent = context === 'dashboard' ? 'Dashboard' : 'Gestione Dispositivi';
            
            setupUserInterface();
            initializeWebSocket();
            loadInitialData();
        }

        function getRoleLabel(role) {
            const roles = {
                'admin': 'Admin',
                'reseller': 'Rivenditore', 
                'customer': 'Cliente'
            };
            return roles[role] || role;
        }

        function setupUserInterface() {
            const isAdmin = appState.user.role === 'admin';
            const isReseller = appState.user.role === 'reseller';
            const isCustomer = appState.user.role === 'customer';
            
            // Show/hide contexts based on current selection
            if (appState.currentContext === 'dashboard') {
                dashboardContext.classList.remove('hidden');
                deviceManagementContext.classList.add('hidden');
            } else {
                dashboardContext.classList.add('hidden');
                deviceManagementContext.classList.remove('hidden');
            }
            
            // Setup device management form based on role
            if (isAdmin) {
                adminFlow.classList.remove('hidden');
                resellerFlow.classList.add('hidden');
                loadResellers();
            } else if (isReseller) {
                adminFlow.classList.add('hidden');
                resellerFlow.classList.remove('hidden');
                loadResellerCustomers();
            } else {
                // Customer cannot add devices
                adminFlow.classList.add('hidden');
                resellerFlow.classList.add('hidden');
                addDeviceForm.classList.add('hidden');
            }
        }

        // === DEVICE MANAGEMENT FUNCTIONS ===

        async function loadResellers() {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const select = document.getElementById('resellerSelect');
                select.innerHTML = '<option value="">Seleziona rivenditore...</option>';
                
                // Demo data
                const resellers = [
                    { resellerCode: 'RES_NORD', company: 'Rivenditore Nord Italia' },
                    { resellerCode: 'RES_CENTRO', company: 'Rivenditore Centro Italia' },
                    { resellerCode: 'RES_SUD', company: 'Rivenditore Sud Italia' }
                ];
                
                resellers.forEach(reseller => {
                    const option = document.createElement('option');
                    option.value = reseller.resellerCode;
                    option.textContent = `${reseller.company} (${reseller.resellerCode})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading resellers:', error);
            }
        }

        async function loadResellerCustomers(resellerCode = null) {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const select = appState.user.role === 'admin' 
                    ? document.getElementById('customerSelect')
                    : document.getElementById('resellerCustomerSelect');
                
                select.innerHTML = '<option value="">Seleziona cliente...</option>';
                
                // Demo data
                const customers = [
                    { username: 'cliente1', company: 'Azienda Cliente 1' },
                    { username: 'cliente2', company: 'Azienda Cliente 2' },
                    { username: 'cliente3', company: 'Azienda Cliente 3' }
                ];
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.username;
                    option.textContent = `${customer.company} (${customer.username})`;
                    select.appendChild(option);
                });
                
                if (appState.user.role === 'admin') {
                    select.disabled = !resellerCode;
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function handleAddDevice(e) {
            e.preventDefault();
            
            const formData = {
                deviceId: document.getElementById('deviceId').value,
                deviceName: document.getElementById('deviceName').value,
                systemType: document.getElementById('systemType').value,
                ownerEmail: document.getElementById('ownerEmail').value,
                location: document.getElementById('location').value
            };
            
            if (appState.user.role === 'admin') {
                formData.resellerCode = document.getElementById('resellerSelect').value;
                formData.owner = document.getElementById('customerSelect').value;
            } else if (appState.user.role === 'reseller') {
                formData.resellerCode = appState.user.resellerCode;
                formData.owner = document.getElementById('resellerCustomerSelect').value;
            } else {
                formData.resellerCode = appState.user.resellerCode;
                formData.owner = appState.user.username;
            }
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Add to local state for demo
                const newDevice = {
                    deviceId: formData.deviceId,
                    deviceName: formData.deviceName,
                    systemType: formData.systemType,
                    owner: formData.owner,
                    resellerCode: formData.resellerCode,
                    isOnline: false,
                    activeAlerts: 0,
                    lastSeen: null,
                    firmwareVersion: '1.0'
                };
                
                appState.devices.push(newDevice);
                appState.hasDevices = true;
                
                addDeviceForm.reset();
                showToast('Dispositivo registrato con successo!', 'success');
                
                // Refresh devices lists
                renderDevicesList();
                renderManagementDevicesList();
                updateWelcomeScreen();
            } catch (error) {
                console.error('Error adding device:', error);
                showToast('Errore durante la registrazione del dispositivo', 'error');
            }
        }

        // === DASHBOARD FUNCTIONS ===

        async function loadInitialData() {
            await loadDevices();
            await loadAlerts();
            updateDashboardStats();
            updateWelcomeScreen();
        }

        async function loadDevices() {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Demo data - in a real app this would come from the server
                if (appState.devices.length === 0) {
                    // Add some demo devices for first load
                    appState.devices = [
                        {
                            deviceId: 'NAB001',
                            deviceName: 'NabulAir Ufficio',
                            systemType: 'pro',
                            owner: 'cliente1',
                            resellerCode: 'RES_NORD',
                            isOnline: true,
                            activeAlerts: 0,
                            lastSeen: new Date(),
                            firmwareVersion: '1.2',
                            latestTelemetry: {
                                status: 'operativo',
                                cicloAttivo: true,
                                secondiRimanenti: 125,
                                volumeAcquaL: 45
                            }
                        },
                        {
                            deviceId: 'NAB002', 
                            deviceName: 'NabulAir Magazzino',
                            systemType: 'pro_duo',
                            owner: 'cliente2',
                            resellerCode: 'RES_NORD',
                            isOnline: false,
                            activeAlerts: 1,
                            lastSeen: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                            firmwareVersion: '1.1'
                        }
                    ];
                    appState.hasDevices = appState.devices.length > 0;
                }
                
                renderDevicesList();
                renderManagementDevicesList();
                updateDashboardStats();
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        function renderDevicesList() {
            if (!appState.devices || appState.devices.length === 0) {
                devicesList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-microchip fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun dispositivo trovato</p>
                    </div>
                `;
                return;
            }
            
            devicesList.innerHTML = appState.devices.map(device => `
                <div class="card device-card mb-3 ${getDeviceStatusClass(device)}" 
                     data-device-id="${device.deviceId}" onclick="selectDevice('${device.deviceId}')">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">${device.deviceName}</h6>
                                <p class="card-text text-muted small mb-1">
                                    <strong>ID:</strong> ${device.deviceId} | 
                                    <strong>Proprietario:</strong> ${device.owner}
                                </p>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-primary system-badge">${device.systemType}</span>
                                    <span class="badge ${device.isOnline ? 'bg-success' : 'bg-secondary'}">
                                        ${device.isOnline ? 'Online' : 'Offline'}
                                    </span>
                                    ${device.activeAlerts > 0 ? 
                                        `<span class="badge bg-warning">${device.activeAlerts} Allerte</span>` : ''}
                                    ${device.latestTelemetry && device.latestTelemetry.cicloAttivo ? 
                                        `<span class="badge bg-info">Ciclo Attivo</span>` : ''}
                                </div>
                            </div>
                            <div class="text-end ms-2">
                                <small class="text-muted d-block">${formatDate(device.lastSeen)}</small>
                                <small class="text-muted">v${device.firmwareVersion || '1.0'}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderManagementDevicesList() {
            if (!appState.devices || appState.devices.length === 0) {
                managementDevicesList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-microchip fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nessun dispositivo registrato</p>
                        <p class="text-muted small">Utilizza il form sopra per registrare il primo dispositivo</p>
                    </div>
                `;
                return;
            }
            
            managementDevicesList.innerHTML = appState.devices.map(device => `
                <div class="card device-card mb-3 ${getDeviceStatusClass(device)}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">${device.deviceName}</h6>
                                <p class="card-text text-muted small mb-1">
                                    <strong>ID:</strong> ${device.deviceId} | 
                                    <strong>Proprietario:</strong> ${device.owner} |
                                    <strong>Rivenditore:</strong> ${device.resellerCode}
                                </p>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-primary system-badge">${device.systemType}</span>
                                    <span class="badge ${device.isOnline ? 'bg-success' : 'bg-secondary'}">
                                        ${device.isOnline ? 'Online' : 'Offline'}
                                    </span>
                                    <span class="badge bg-light text-dark">Registrato</span>
                                </div>
                            </div>
                            <div class="text-end ms-2">
                                <small class="text-muted d-block">${formatDate(device.lastSeen)}</small>
                                <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeDevice('${device.deviceId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getDeviceStatusClass(device) {
            if (device.activeAlerts > 0) return 'device-alert';
            if (device.isOnline) return 'device-online';
            return 'device-offline';
        }

        function updateWelcomeScreen() {
            if (appState.hasDevices) {
                welcomeScreen.classList.add('hidden');
            } else {
                welcomeScreen.classList.remove('hidden');
            }
        }

        function selectDevice(deviceId) {
            appState.selectedDevice = appState.devices.find(d => d.deviceId === deviceId);
            
            selectedDeviceName.textContent = appState.selectedDevice.deviceName;
            onlineStatusBadge.classList.toggle('hidden', !appState.selectedDevice.isOnline);
            
            updateDeviceControls();
            loadDeviceTelemetry(deviceId);
        }

        async function loadDeviceTelemetry(deviceId) {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Demo telemetry data
                const telemetryData = {
                    deviceId: deviceId,
                    status: 'operativo',
                    cicloAttivo: true,
                    secondiRimanenti: 125,
                    volumeAcquaL: 45,
                    timestamp: new Date()
                };
                
                updateTelemetryDisplay(telemetryData);
                initializeTelemetryChart([telemetryData]);
            } catch (error) {
                console.error('Error loading device telemetry:', error);
            }
        }

        function updateTelemetryDisplay(latestTelemetry) {
            if (!latestTelemetry) {
                telemetryStatus.textContent = '--';
                telemetryCiclo.textContent = '--';
                telemetrySecondi.textContent = '--';
                telemetryVolume.textContent = '--';
                return;
            }
            
            telemetryStatus.textContent = latestTelemetry.status || '--';
            telemetryCiclo.textContent = latestTelemetry.cicloAttivo ? 'Sì' : 'No';
            telemetrySecondi.textContent = latestTelemetry.secondiRimanenti || '--';
            telemetryVolume.textContent = latestTelemetry.volumeAcquaL || '--';
        }

        function updateDeviceControls() {
            const isOnline = appState.selectedDevice && appState.selectedDevice.isOnline;
            
            startCycleBtn.disabled = !isOnline;
            stopCycleBtn.disabled = !isOnline;
            rebootDeviceBtn.disabled = !isOnline;
        }

        async function loadAlerts() {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Demo alerts
                const alerts = [
                    {
                        _id: 'alert1',
                        deviceId: 'NAB002',
                        message: 'Temperatura fuori range',
                        severity: 'medium',
                        createdAt: new Date(Date.now() - 30 * 60 * 1000) // 30 minutes ago
                    }
                ];
                
                renderAlerts(alerts);
                
                if (alerts.length > 0) {
                    alertsSection.classList.remove('hidden');
                } else {
                    alertsSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function renderAlerts(alerts) {
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p class="text-muted text-center">Nessuna allerta attiva</p>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>${alert.deviceId}</strong>: ${alert.message}
                            <div class="mt-1">
                                <small class="text-muted">
                                    ${formatDate(alert.createdAt)} • 
                                    Severità: <span class="badge bg-${getSeverityBadgeColor(alert.severity)}">${alert.severity}</span>
                                </small>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" 
                                onclick="resolveAlert('${alert._id}')"></button>
                    </div>
                </div>
            `).join('');
        }

        function getSeverityBadgeColor(severity) {
            const colors = {
                'critical': 'danger',
                'high': 'danger', 
                'medium': 'warning',
                'low': 'info'
            };
            return colors[severity] || 'secondary';
        }

        async function resolveAlert(alertId) {
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update device alert count
                const alert = appState.devices.find(d => d.activeAlerts > 0);
                if (alert) {
                    alert.activeAlerts = Math.max(0, alert.activeAlerts - 1);
                }
                
                loadAlerts();
                renderDevicesList();
                updateDashboardStats();
                
                showToast('Allerta risolta', 'success');
            } catch (error) {
                console.error('Error resolving alert:', error);
            }
        }

        function updateDashboardStats() {
            const total = appState.devices.length;
            const online = appState.devices.filter(d => d.isOnline).length;
            const alertCount = appState.devices.reduce((sum, device) => sum + (device.activeAlerts || 0), 0);
            
            document.getElementById('totalDevices').textContent = total;
            document.getElementById('onlineDevices').textContent = online;
            document.getElementById('alertDevices').textContent = alertCount;
            document.getElementById('dataPoints').textContent = total * 24; // Simulated data points
        }

        // === WEB SOCKET AND REAL-TIME FUNCTIONALITY ===

        function initializeWebSocket() {
            // In a real app, this would connect to your WebSocket server
            console.log('WebSocket connection simulated - would connect to real server in production');
            
            // Simulate real-time updates
            setInterval(() => {
                if (appState.devices.length > 0 && Math.random() > 0.7) {
                    // Randomly update device status
                    const randomDevice = appState.devices[Math.floor(Math.random() * appState.devices.length)];
                    randomDevice.isOnline = Math.random() > 0.3;
                    randomDevice.lastSeen = new Date();
                    
                    if (randomDevice.isOnline && Math.random() > 0.8) {
                        // Simulate telemetry update
                        randomDevice.latestTelemetry = {
                            status: 'operativo',
                            cicloAttivo: Math.random() > 0.5,
                            secondiRimanenti: Math.floor(Math.random() * 300),
                            volumeAcquaL: Math.floor(Math.random() * 100),
                            timestamp: new Date()
                        };
                        
                        if (appState.selectedDevice && appState.selectedDevice.deviceId === randomDevice.deviceId) {
                            updateTelemetryDisplay(randomDevice.latestTelemetry);
                        }
                    }
                    
                    renderDevicesList();
                    updateDashboardStats();
                }
            }, 5000);
        }

        async function sendCommand(commandType) {
            if (!appState.selectedDevice) return;
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 800));
                
                showToast(`Comando ${commandType} inviato al dispositivo`, 'success');
                
                // Simulate command effect
                if (commandType === 'start_cycle' && appState.selectedDevice.latestTelemetry) {
                    appState.selectedDevice.latestTelemetry.cicloAttivo = true;
                    appState.selectedDevice.latestTelemetry.secondiRimanenti = 300;
                    updateTelemetryDisplay(appState.selectedDevice.latestTelemetry);
                } else if (commandType === 'stop_cycle' && appState.selectedDevice.latestTelemetry) {
                    appState.selectedDevice.latestTelemetry.cicloAttivo = false;
                    appState.selectedDevice.latestTelemetry.secondiRimanenti = 0;
                    updateTelemetryDisplay(appState.selectedDevice.latestTelemetry);
                }
            } catch (error) {
                console.error('Error sending command:', error);
                showToast('Errore nell\'invio del comando', 'error');
            }
        }

        function initializeTelemetryChart(telemetryData) {
            const ctx = document.getElementById('telemetryChart').getContext('2d');
            
            if (appState.chart) {
                appState.chart.destroy();
            }
            
            // Create sample data for the chart
            const labels = [];
            const data = [];
            
            for (let i = 0; i < 10; i++) {
                labels.push(`Ora -${10-i}`);
                data.push(Math.floor(Math.random() * 100));
            }
            
            appState.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume Acqua (L)',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Litri'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tempo'
                            }
                        }
                    }
                }
            });
        }

        // === UTILITY FUNCTIONS ===

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function removeDevice(deviceId) {
            if (confirm('Sei sicuro di voler rimuovere questo dispositivo?')) {
                appState.devices = appState.devices.filter(d => d.deviceId !== deviceId);
                appState.hasDevices = appState.devices.length > 0;
                
                if (appState.selectedDevice && appState.selectedDevice.deviceId === deviceId) {
                    appState.selectedDevice = null;
                    selectedDeviceName.textContent = 'Telemetria';
                    onlineStatusBadge.classList.add('hidden');
                    updateTelemetryDisplay(null);
                }
                
                renderDevicesList();
                renderManagementDevicesList();
                updateDashboardStats();
                updateWelcomeScreen();
                
                showToast('Dispositivo rimosso', 'success');
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            
            // Reset app state
            appState.user = null;
            appState.token = null;
            appState.devices = [];
            appState.selectedDevice = null;
            appState.hasDevices = false;
            
            appSection.classList.add('hidden');
            contextSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            
            loginForm.reset();
            registerForm.reset();
            registerError.classList.add('hidden');
            registerSuccess.classList.add('hidden');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Mai';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Ora';
            if (diffMins < 60) return `${diffMins} min fa`;
            if (diffHours < 24) return `${diffHours} ore fa`;
            
            return date.toLocaleDateString('it-IT');
        }

        // Make functions available globally
        window.selectDevice = selectDevice;
        window.resolveAlert = resolveAlert;
        window.removeDevice = removeDevice;
    </script>
</body>
</html>
=======
    <title>NabulAir Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .card { background: white; border-radius: 8px; padding: 1rem; margin: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { background: #3498db; color: white; padding: 1rem; border-radius: 6px; text-align: center; }
        .device-list { display: grid; gap: 1rem; }
        .device-card { border-left: 4px solid #2ecc71; padding: 1rem; }
        .device-card.offline { border-left-color: #e74c3c; }
        .login-form { max-width: 400px; margin: 2rem auto; }
        .form-group { margin: 1rem 0; }
        input { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🌿 NabulAir Monitor</h1>
        </div>
    </div>
    
    <div class="container">
        <div id="loginView" class="login-form card">
            <h2>Accesso</h2>
            <div class="form-group">
                <input type="text" id="username" placeholder="Username" required>
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button onclick="login()">Accedi</button>
        </div>

        <div id="dashboardView" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Dispositivi Totali</h3>
                    <p id="totalDevices">0</p>
                </div>
                <div class="stat-card">
                    <h3>Online</h3>
                    <p id="onlineDevices">0</p>
                </div>
                <div class="stat-card">
                    <h3>Allerta Attive</h3>
                    <p id="activeAlerts">0</p>
                </div>
            </div>

            <div class="card">
                <h2>Dispositivi</h2>
                <div id="deviceList" class="device-list"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let ws = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    showDashboard();
                    connectWebSocket();
                    loadDashboard();
                } else {
                    alert('Login fallito: ' + data.error);
                }
            } catch (error) {
                alert('Errore di connessione');
            }
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: 'auth',
                    token: localStorage.getItem('token')
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'telemetry_update':
                    updateDeviceStatus(data.deviceId, data.data);
                    break;
                case 'alert_created':
                    showAlert(data.alert);
                    break;
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();

                if (data.success) {
                    updateDashboard(data.dashboard);
                }
            } catch (error) {
                console.error('Errore caricamento dashboard:', error);
            }
        }

        function updateDashboard(dashboard) {
            document.getElementById('totalDevices').textContent = dashboard.totalDevices;
            document.getElementById('onlineDevices').textContent = dashboard.deviceStatus.online || 0;
            document.getElementById('activeAlerts').textContent = dashboard.alertSeverity.high || 0;
        }

        function showDashboard() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
        }

        // Auto-login se token presente
        const token = localStorage.getItem('token');
        if (token) {
            // Verifica token e mostra dashboard
            showDashboard();
            connectWebSocket();
            loadDashboard();
        }
    </script>
</body>
</html>
>>>>>>> fa7dcad7d1a4a3b10f8540d9885f9a98559a5b25
